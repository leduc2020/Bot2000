#!/usr/bin/env node


const chokidar = require('chokidar');

const spawn = require('child_process').spawn;


let [_, __, command] = process.argv
command = command || `love .`  

const debounce = function(fn) {
  let ti;
  return function () {
    clearTimeout(ti);
    ti = setTimeout(fn, 1000);
  }
}

const doreload = () => {
  console.log(command);
  let [com, ...rest] = command.split(' ');
  let ping = spawn(com, rest);


  ping.stdout.on('data', data => console.log(data.toString()));
  ping.on('close', () => console.log('closed'));
  return ping;
};


let childp;
const safereload = debounce(() => {

  if (childp) {
    childp.kill('SIGINT');
  }

  console.log('Reloading...');
  childp = doreload();

});

console.log('Watching lua files..');
chokidar.watch(['*.lua'], {
}).on('all', (event, path) => {
  safereload();
});

safereload();
